[{"id":"af5d4fae.0d088","type":"subflow","name":"Send variable to Ubidots","info":"Sends the message part of the payload.\nNeeds:\nmsg.payload (data: ie {'value':1.2, 'content' : { 'message' : MESSAGE }}) ->\nmsg.token\nmsg.variableId","in":[{"x":400,"y":380,"wires":[{"id":"578aef4.9b9c81"}]}],"out":[]},{"id":"578aef4.9b9c81","type":"function","z":"af5d4fae.0d088","name":"Ubidots send variable","func":"\nvar data = msg.payload;\n\nmsg.headers = {\n    'Content-Type' : 'application/json',\n    'Content-Length' : data.length,\n    'X-Auth-Token' : msg.token\n};\nmsg.method = \"POST\";\nmsg.payload = data;\n\nreturn msg;\n","outputs":1,"noerr":0,"x":580,"y":380,"wires":[["c94890bd.23053"]]},{"id":"c94890bd.23053","type":"http request","z":"af5d4fae.0d088","name":"","method":"use","ret":"obj","url":"http://things.ubidots.com/api/v1.6/variables/{{{variableId}}}/values/","tls":"","x":850,"y":260,"wires":[[]]},{"id":"72d0a297.89d43c","type":"debug","z":"af5d4fae.0d088","name":"","active":true,"console":"false","complete":"payload","x":850,"y":520,"wires":[]},{"id":"8ee41811.605878","type":"debug","z":"af5d4fae.0d088","name":"","active":true,"console":"false","complete":"statusCode","x":1064.5,"y":260,"wires":[]},{"id":"9e6b81f2.02ada","type":"mqtt in","z":"9942e133.ef79e","name":"","topic":"/dev/liamroom-boxend-motion","qos":"0","broker":"8fb4c14f.3a4c4","x":140,"y":540,"wires":[["b2295d67.fbb51","dd1c43a0.ce8e6"]]},{"id":"96016faf.472ec","type":"mqtt in","z":"9942e133.ef79e","name":"","topic":"/dev/liamroom-lid-motion","qos":"0","broker":"8fb4c14f.3a4c4","x":130,"y":260,"wires":[["7f36f4d6.d03f5c","23d8c876.574178"]]},{"id":"911bd45.6c22428","type":"play audio","z":"9942e133.ef79e","name":"","voice":"3","x":570,"y":260,"wires":[]},{"id":"7f36f4d6.d03f5c","type":"function","z":"9942e133.ef79e","name":"Motion Lid","func":"msg = {};\nmsg.payload = \"Motion, Lid\";\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":260,"wires":[[]]},{"id":"b2295d67.fbb51","type":"function","z":"9942e133.ef79e","name":"Motion Box End","func":"msg = {};\nmsg.payload = \"Motion, Box end\";\nreturn msg;","outputs":1,"noerr":0,"x":400,"y":540,"wires":[[]]},{"id":"81cfe093.602bd","type":"function","z":"9942e133.ef79e","name":"Setup \"Liam Room Door - Motion\"","func":"\nvar payload = msg.payload;\n\nif (payload === \"\") {\n    return;\n}\n\nmsg.token = \"GioE85MkDexLpsbE1Tt37F3TY2p3Fa6XM4bKvftz9OfC87MrH5bQGceJrVgF\";\n\nmsg.variableId = \"58abde8c76254260e42f1632\";\n\nmsg.payload = \"\";\nif (payload !== \"\") {\n    msg.payload = \"{ \\\"value\\\" : 1.2, \\\"context\\\" : { \\\"message\\\" : \\\"\" + payload + \"\\\" }}\";\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":920,"y":360,"wires":[["1a02e2ea.d4810d","22df3554.bcd26a"]]},{"id":"1a02e2ea.d4810d","type":"subflow:af5d4fae.0d088","z":"9942e133.ef79e","name":"Send door event","x":1000.6430053710938,"y":424.6880187988281,"wires":[]},{"id":"3b8ed00a.c557c","type":"inject","z":"9942e133.ef79e","name":"/dev/liamroom-lid-motion","topic":"/dev/liamroom-lid-motion","payload":"1","payloadType":"str","repeat":"","crontab":"","once":false,"x":130,"y":220,"wires":[["23d8c876.574178"]]},{"id":"c0b2ad6f.d4d0f","type":"inject","z":"9942e133.ef79e","name":"/dev/liamroom-boxend-motion","topic":"/dev/liamroom-boxend-motion","payload":"1","payloadType":"str","repeat":"","crontab":"","once":false,"x":160,"y":580,"wires":[["dd1c43a0.ce8e6"]]},{"id":"e87230da.cb606","type":"mqtt in","z":"9942e133.ef79e","name":"","topic":"/dev/liamroom-lid-online","qos":"0","broker":"8fb4c14f.3a4c4","x":120,"y":100,"wires":[["3f2740c0.a020c"]]},{"id":"3f2740c0.a020c","type":"trigger","z":"9942e133.ef79e","op1":"1","op2":"0","op1type":"str","op2type":"str","duration":"800","extend":false,"units":"ms","reset":"","name":"Pulse","x":330,"y":100,"wires":[[]]},{"id":"78c263eb.844f2c","type":"mqtt in","z":"9942e133.ef79e","name":"","topic":"/dev/liamroom-boxend-online","qos":"2","broker":"8fb4c14f.3a4c4","x":140,"y":40,"wires":[["ebd9f12f.713da"]]},{"id":"ebd9f12f.713da","type":"trigger","z":"9942e133.ef79e","op1":"1","op2":"0","op1type":"str","op2type":"str","duration":"800","extend":false,"units":"ms","reset":"","name":"Pulse","x":330,"y":40,"wires":[[]]},{"id":"bbd5332d.bf6e6","type":"debug","z":"9942e133.ef79e","name":"","active":true,"console":"false","complete":"false","x":770,"y":460,"wires":[]},{"id":"43b282b7.a9ac5c","type":"function","z":"9942e133.ef79e","name":"GetDirection","func":"\ncontext.global.inTripWindow = function(lastRead, tStamp) { return tStamp - lastRead < 2500; }\n\nvar timestamp = global.get(\"timestamp\");\n\nvar topic = msg.topic;\n\nmsg = {};\n\ncontext.boxend_lastread = context.boxend_lastread || 0;\ncontext.lid_lastread = context.lid_lastread || 0;\ncontext.last_direction = context.last_direction || 0;\n\nmsg.payload = \"\";\n\nswitch (topic) {\n    \n    case \"/dev/liamroom-boxend-motion\":\n        context.boxend_lastread = timestamp;\n\n        var soonEnough = context.global.inTripWindow(context.lid_lastread, timestamp);\n        if (soonEnough) {\n            msg.payload = \"ENTRY\";\n            context.last_direction = \"ENTRY\";\n        } else {\n            return;\n        }\n        break;\n        \n    // lid\n    case \"/dev/liamroom-lid-motion\":\n        context.lid_lastread = timestamp;\n\n        var soonEnough = context.global.inTripWindow(context.boxend_lastread, timestamp);\n        if (soonEnough) {\n            msg.payload = \"EXIT!!!\";\n            context.last_direction = \"EXIT\";\n        } else {\n            return;\n        }\n        break;\n    default:\n        return;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":430,"y":440,"wires":[["b028a7c3.a8ec78"]]},{"id":"22df3554.bcd26a","type":"debug","z":"9942e133.ef79e","name":"","active":false,"console":"false","complete":"true","x":970,"y":480,"wires":[]},{"id":"4f979bd3.2a5684","type":"debug","z":"9942e133.ef79e","name":"","active":true,"console":"false","complete":"false","x":570,"y":340,"wires":[]},{"id":"12af8fee.768d2","type":"function","z":"9942e133.ef79e","name":"Process Topics","func":"                                                \nvar timestamp = Date.now();\nvar now = new Date(timestamp);\n\nvar payload = msg.payload;\n\nif (now.getHours() > 7 && now.getHours() < 12) {\n    return;\n}\n\nif (msg.topic == \"/dev/liamroom-lid-motion\") {\n    msg.payload = \"Motion: Lid\";\n}\nelse if (msg.topic == \"/dev/liamroom-boxend-motion\") {\n    msg.payload = \"Motion: Box End\";\n}\nelse {\n    return;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":380,"y":380,"wires":[["4f979bd3.2a5684","43b282b7.a9ac5c","81cfe093.602bd"]]},{"id":"405ee525.f8ed7c","type":"inject","z":"9942e133.ef79e","name":"/config/seconds-until-next-read","topic":"/config/seconds-until-next-read","payload":"3","payloadType":"num","repeat":"","crontab":"","once":true,"x":350,"y":820,"wires":[["125900d7.3a035f"]]},{"id":"125900d7.3a035f","type":"function","z":"9942e133.ef79e","name":"Config","func":"\nif (msg.topic == \"/config/seconds-until-next-read\") {\n    flow.set(\"seconds_until_next_read\", msg.payload * 1000);\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":570,"y":820,"wires":[[]]},{"id":"dd1c43a0.ce8e6","type":"delay","z":"9942e133.ef79e","name":"Limit Rate","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"5","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"x":170,"y":440,"wires":[["12af8fee.768d2"]]},{"id":"23d8c876.574178","type":"delay","z":"9942e133.ef79e","name":"Limit Rate","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"5","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"x":170,"y":400,"wires":[["12af8fee.768d2"]]},{"id":"5fea0862.441848","type":"play audio","z":"9942e133.ef79e","name":"","voice":"3","x":590,"y":540,"wires":[]},{"id":"aadb2976.bc3148","type":"ui_button","z":"9942e133.ef79e","name":"","group":"96fb0076.96056","order":0,"width":"3","height":"1","label":"Lid","color":"","bgcolor":"","icon":"","payload":"1","payloadType":"str","topic":"/dev/liamroom-lid-motion","x":70,"y":180,"wires":[["23d8c876.574178"]]},{"id":"b84968bb.822b88","type":"ui_button","z":"9942e133.ef79e","name":"","group":"96fb0076.96056","order":0,"width":"3","height":"1","label":"Box End","color":"","bgcolor":"","icon":"","payload":"1","payloadType":"str","topic":"/dev/liamroom-boxend-motion","x":100,"y":620,"wires":[["dd1c43a0.ce8e6"]]},{"id":"b028a7c3.a8ec78","type":"delay","z":"9942e133.ef79e","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":600,"y":440,"wires":[["81cfe093.602bd","bbd5332d.bf6e6"]]},{"id":"8fb4c14f.3a4c4","type":"mqtt-broker","z":"","broker":"localhost","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"willTopic":"","willQos":"0","willPayload":"","birthTopic":"","birthQos":"0","birthPayload":""},{"id":"96fb0076.96056","type":"ui_group","name":"Group 1","tab":"5e02494a.008278","order":1,"disp":true,"width":6},{"id":"5e02494a.008278","type":"ui_tab","z":"","name":"Feeds","icon":"dashboard","order":1}]